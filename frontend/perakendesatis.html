<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Klas Perakende Satış</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <!-- Bootstrap Bundle (with Popper) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <!-- Popper -->
  <script
    src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"
  ></script>
  <!-- Bootstrap JavaScript -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"
  ></script>
  <!-- jsPDF Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <!-- jsPDF autoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <!-- Google Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    rel="stylesheet"
  />
  <!-- Flatpickr CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
  />
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
  <!-- SweetAlert CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<!-- SweetAlert JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .logo:hover {
      transform: scale(1.1);
      transition: transform 0.3s ease;
    }
    .modern-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.5rem;
      color: #333;
      text-shadow: none;
      transition: color 0.3s ease, transform 0.3s ease;
      animation: fadeIn 1.2s ease-in-out;
    }
    .modern-title:hover {
      color: #0d6efd;
      transform: scale(1.05);
    }
    .form-check-label.active {
      background-color: #0d6efd;
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
    }
    .toggle-option {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border: 1px solid #0d6efd;
      border-radius: 0.25rem;
      margin-right: 0.5rem;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-weight: bold;
      border: none;
    }
    .toggle-option.active {
      background-color: #0d6efd;
      color: white;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      background: url('https://example.com/cat-dog-icons.png') repeat;
      background-size: 150px 150px;
      animation: fadeIn 1s ease-in-out;
    }
    header {
      background: linear-gradient(to right, #a1c4fd, #c2e9fb);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: slideDown 0.8s ease-in-out;
    }
    .card {
      border: none;
      border-radius: 15px;
      overflow: visible;
      transition: box-shadow 0.3s ease;
      background: #ffffff;
      height: auto;
    }
    .card:hover {
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
    }
    .form-control,
    .form-select {
      border-radius: 10px;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }
    .form-control:focus,
    .form-select:focus {
      box-shadow: 0 0 8px rgba(161, 196, 253, 0.5);
      transform: scale(1.02);
    }
    #corporateOption {
      background: #0d6efd;
      color: white;
    }
    #corporateOption:hover {
      background: #0b5ed7;
    }
    #corporateOption.active {
      background: #0a58ca;
    }
    #individualOption {
      background: #ff9a8b;
      color: white;
    }
    #individualOption:hover {
      background: #ff6a88;
    }
    #individualOption.active {
      background: #ff6a88;
    }
    footer {
      background: linear-gradient(to right, #a1c4fd, #c2e9fb);
      animation: fadeIn 1.5s ease-in-out;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
    footer p {
      font-size: 0.9rem;
      color: #555;
      letter-spacing: 0.5px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .table-primary {
      background-color: #0d6efd !important;
      color: white !important;
    }
    .card-header.bg-light {
      background-color: #476899 !important;
      color: white !important;
    }
    #proformaButton {
      font-size: 0.9rem;
      padding: 0.5625rem 1.125rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 0.375rem;
      box-shadow: 0 3px 4.5px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    #proformaButton:hover {
      background-color: #218838;
      transform: scale(1.05);
      box-shadow: 0 4.5px 7.5px rgba(0, 0, 0, 0.15);
    }
    #proformaButton:focus {
      outline: none;
      box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.5);
    }
    input[readonly] {
      background-color: #e9ecef;
      cursor: not-allowed;
    }
    #siparisTarihi,
    #teslimTarihi {
      background-color: #ffffff;
    }
    .input-group {
    display: flex;
    align-items: center; /* Dikey hizalamayı sabitler */
    }
    .input-group .form-control {
    flex: 1; /* Input alanının genişliğini esnek yapar */
    }
   .input-group .btn {
    flex-shrink: 0; /* Butonun boyutunun küçülmesini engeller */
    }
    .input-group-text {
      width: 120px;
      text-align: center;
    }
    .add-customer-btn:hover {
      color: #ffffff;
      transition: color 0.3s ease;
    }
    #productSelectionCard {
      display: none;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Üstbilgi -->
  <header class="bg-white shadow-sm py-3">
    <div class="container d-flex flex-wrap align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <img
          src="https://uzser.com/images/uzser_logo_yeni_transparent.png"
          alt="Logo"
          class="me-3 logo"
          style="height: 80px; width: auto;"
        />
      </div>
      <h3 class="text-shadow fw-bold text-center mb-0 modern-title" style="font-size: 1.9rem;">
        Klas Perakende Satış
      </h3>
      <div class="d-flex flex-column align-items-start" style="max-width: 400px;">
        <div class="input-group mb-2">
          <span class="input-group-text bg-primary text-white border-0" id="orderCodeLabel" name="ordernumber" style="width: 150px;">Sipariş No</span>
          <input
            type="text"
            id="orderCodeHeader"
            class="form-control data-mas"
            placeholder="NRP202500001"
            style="width: 250px;"
            readonly
          />
        </div>
        <div class="input-group">
          <span class="input-group-text bg-primary text-white border-0" id="plasiyerLabel" name="salesrepno" style="width: 150px;">Plasiyer</span>
          <input
            type="text"
            id="plasiyerInput"
            class="form-control data-mas"
            value=""
            placeholder="Plasiyer giriniz"
            style="width: 250px;"
            readonly
          />
        </div>
      </div>
    </div>
  </header>

  <!-- Gövde -->
  <main class="container my-5">
    <!-- Sipariş Üst Bilgisi -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
        <span>Sipariş Üst Bilgisi</span>
        <button class="btn btn-sm btn-primary" id="toggleOrderInfo" onclick="toggleOrderInfo()">
          <i class="bi bi-dash-lg" id="toggleOrderInfoIcon"></i>
        </button>
      </div>
      <div class="card-body" id="orderInfoBody">
        <div class="row g-4"><!-- g-3 yerine g-4 -->
          <!-- Müşteri Seçimi ve Araç Seçimi -->
          <div class="row g-4 gx-5"><!-- gx-5 ile yatay boşluk artırıldı -->
  <!-- Müşteri Seçimi -->
  <div class="col-md-6">
    <label for="customerSelection" class="form-label">Müşteri Seçimi</label>
    <div class="input-group">
      <input type="text" name="customercode" class="form-control data-mas" id="customerSelection" placeholder="Müşteri adı veya kodu giriniz..." autocomplete="off" oninput="filterCustomers()" onfocus="expandCustomerField()" />
      <button class="btn btn-outline-secondary add-customer-btn" type="button" onclick="openNewCustomerModal()">
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>
    <ul class="dropdown-menu w-100" id="customerDropdown" style="max-height: 200px; overflow-y: auto;"></ul>
  </div>
  <!-- Araç Seçimi -->
  <div class="col-md-6">
    <label for="vehicleSelection" class="form-label">Araç Seçimi</label>
    <div class="input-group">
      <input type="text" class="form-control" id="vehicleSelection" placeholder="Plaka veya şasi numarası giriniz..." autocomplete="off" oninput="filterVehicles()" onfocus="expandVehicleField()" />
      <button class="btn btn-outline-secondary add-vehicle-btn" type="button" onclick="openNewVehicleModal()">
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>
    <ul class="dropdown-menu w-100" id="vehicleDropdown" style="max-height: 200px; overflow-y: auto;"></ul>
  </div>
</div>
        </div>
        <div class="row g-4 mt-3"><!-- Buraya mt-4 eklendi -->
          <!-- Sipariş Tarihi, Teslim Tarihi, Açıklama 1, Açıklama 2, İskonto Oranı, Id -->
          <div class="col-md-2">
            <label for="siparisTarihi" class="form-label">Sipariş Tarihi</label>
            <input type="text" name="orderdate" class="form-control data-mas" id="siparisTarihi" />
          </div>
          <div class="col-md-2">
            <label for="teslimTarihi" class="form-label">Teslim Tarihi</label>
            <input type="text" name="deliverydate" class="form-control data-mas" id="teslimTarihi" />
          </div>
		  
          <!-- Açıklama 1 -->
          <div class="col-md-3">
            <label for="aciklama1" class="form-label">Açıklama 1</label>
            <input type="text" name="description" class="form-control data-mas" id="aciklama1" placeholder="Açıklama giriniz" />
          </div>
          <!-- Açıklama 2 -->
          <div class="col-md-3">
            <label for="aciklama2" class="form-label">Açıklama 2</label>
            <input type="text" name="description2" class="form-control data-mas" id="aciklama2" placeholder="Açıklama giriniz" />
          </div>
		  <div class="col-md-2">
    <label for="iskontoOrani" class="form-label">İskonto Oranı (%)</label>
    <input type="number" name="discount" class="form-control data-mas" id="iskontoOrani" min="0" max="100" step="0.01" value="0" />
    <input type="hidden" name="Id" class="form-control data-mas" id="masId" />
  </div>
        </div>
        <div class="row mt-4">
  <div class="col-12">
    <button class="btn btn-success" style="min-width:200px;" onclick="kaydetMas()">
      Sipariş Üst Bilgiyi Kaydet
    </button>
  </div>
</div>
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-12">
        <div class="card shadow-sm" id="productSelectionCard">
          <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
            <span>Ürün Seçimi Bilgileri</span>
            <button id="proformaButton" class="btn d-none" onclick="generateProforma()">Proforma Oluştur</button>
          </div>
          <div class="card-body">
            <!-- Ürün Seçimi ve Miktar -->
            
   <div class="row">
  <!-- Ürün Seçimi -->
  <div class="col-md-9">
    <div class="mb-3">
      <label for="productSelection" class="form-label">Ürün Seçimi</label>
      <input type="text" class="form-control" id="productSelection" placeholder="Ürün adı veya kodu giriniz..." autocomplete="off" oninput="filterProducts()" onfocus="showAllProducts()" />
      <ul class="dropdown-menu" id="productDropdown" style="max-height: 200px; overflow-y: auto; position: absolute; z-index: 1050; width: 100%;"></ul>
    </div>
  </div>
</div>

<div class="row">
  <!-- Miktar -->
  <div class="col-md-3">
    <div class="mb-3">
      <label for="productQuantity" class="form-label">Miktar</label>
      <input type="number" class="form-control" id="productQuantity" placeholder="Miktar" min="1" onkeypress="handleEnter(event)" />
    </div>
  </div>

  <!-- Fiyat -->
  <div class="col-md-3">
    <div class="mb-3">
      <label for="productPrice" class="form-label">Fiyat</label>
      <input type="number" class="form-control" id="productPrice" placeholder="Fiyat" min="0" step="0.01" />
    </div>
  </div>
<!-- ISKONTO -->
  <div class="col-md-3">
  <div class="mb-3">
    <label for="productDiscount" class="form-label">İskonto (%)</label>
    <input type="number" class="form-control" id="productDiscount" placeholder="İskonto" min="0" max="100" step="0.01" value="0" />
  </div>
</div>

  <!-- Döviz Tipi ve Ekle Butonu -->
  <div class="col-md-3">
    <div class="mb-3">
      <label for="currencyType" class="form-label">Döviz Tipi</label>
      <div class="input-group">
        <select class="form-select" id="currencyType">
          <option value="TRY">TRY</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>
        <button class="btn btn-primary" type="button" onclick="addProduct()">Ekle</button>
      </div>
    </div>
  </div>
      <div class="row">
  <!-- Ürün Seçimi -->
  <div class="col-md-9">
    <div class="mb-3">
      <label for="productSelection" class="form-label">Açıklama </label>
      <input type="text" class="form-control" id="description" placeholder="Açıklama giriniz..."  />
     
    </div>
  </div>
</div>
</div>
 

            <!-- Ürün Tablosu -->
            <div class="row mt-4">
  <div class="col-12">
    <table class="table table-striped table-hover align-middle" id="productTable">
      <thead class="table-primary">
        <tr>
          <th>#</th>
          <th>Ürün Kodu</th>
          <th>Ürün Adı</th>
          <th>Fiyat</th>
          <th>Döviz</th>
          <th style="width: 100px;">Miktar</th>
          <th>İskonto (%)</th>
          <th>Açıklama</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody>
        <!-- Ürün satırları buraya eklenecek -->
      </tbody>
    </table>
  </div>
</div>

          </div>
        </div>
      </div>
    </div>
    <div class="container mt-4 d-flex justify-content-end">
      <button class="btn btn-primary d-none" id="siparisiOlusturButton" onclick="siparisiOlustur()">Siparişi Oluştur</button>
    </div>
  </main>

  <div id="errorAlert" class="alert alert-danger d-none position-fixed top-0 start-50 translate-middle-x mt-3 shadow" role="alert" style="z-index: 1050;">
    Lütfen bir ürün seçiniz!
  </div>

  <footer class="bg-primary text-white py-3">
    <div class="container text-center">
      <p class="mb-0">Copyright © 2024. Created by Uzser Bilişim Hizmetleri</p>
    </div>
  </footer>

  <!-- Yeni Müşteri Modal (Body tag'inin içine ekleyin) -->
  <div class="modal fade" id="newCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yeni Müşteri Ekle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="newCustomerForm" class="row g-3">
            <div class="col-md-6">
              <label for="newCustomerName" class="form-label">Cari İsim *</label>
              <input type="text" class="form-control" id="newCustomerName" required>
            </div>
            <div class="col-md-6">
              <label for="newCustomerCode" class="form-label">Müşteri Kodu *</label>
              <input type="text" class="form-control data-cari" id="newCustomerCode" required>
            </div>
            <div class="col-md-6">
              <label for="vknTc" class="form-label">VKN/TC *</label>
              <input type="text" class="form-control data-cari" id="vknTc" required>
            </div>
            <div class="col-md-6">
              <label for="vergiDairesi" class="form-label">Vergi Dairesi</label>
              <input type="text" class="form-control data-cari" id="vergiDairesi">
            </div>
            <div class="col-12">
              <label for="adres" class="form-label">Adres</label>
              <textarea class="form-control data-cari" id="adres" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label for="telefon" class="form-label">Telefon</label>
              <input type="tel" class="form-control data-cari" id="telefon">
            </div>
            <div class="col-md-6">
              <label for="odemeTipi" class="form-label">Ödeme Tipi</label>
              <select class="form-select data-cari" id="odemeTipi">
                <option value="">Seçiniz...</option>
                <option value="Nakit">Nakit</option>
                <option value="Kredi Kartı">Kredi Kartı</option>
         
              </select>
            </div>
            <div class="col-md-6">
              <label for="eposta" class="form-label">E-posta</label>
              <input type="email" class="form-control data-cari" id="eposta">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
          <button type="button" class="btn btn-primary" onclick="saveNewCustomer()">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Araç Ekle Modal -->
<div class="modal fade" id="newVehicleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Yeni Araç Ekle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="newVehiclePlate" class="form-label">Plaka *</label>
            <input type="text" class="form-control" id="newVehiclePlate" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleChassis" class="form-label">Şase No *</label>
            <input type="text" class="form-control" id="newVehicleChassis" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleEngine" class="form-label">Motor No *</label>
            <input type="text" class="form-control" id="newVehicleEngine" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleBrand" class="form-label">Araç Marka *</label>
            <input type="text" class="form-control" id="newVehicleBrand" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleModel" class="form-label">Araç Model *</label>
            <input type="text" class="form-control" id="newVehicleModel" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleYear" class="form-label">Model Yılı *</label>
            <input type="number" class="form-control" id="newVehicleYear" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleFuelType" class="form-label">Yakıt Tipi *</label>
            <select class="form-select" id="newVehicleFuelType" required>
              <option value="">Seçiniz...</option>
              <option value="Benzin">Benzin</option>
              <option value="Dizel">Dizel</option>
              <option value="Elektrik">Elektrik</option>
              <option value="Hibrit">Hibrit</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="newVehiclePower" class="form-label">Motor Gücü (HP) *</label>
            <input type="number" class="form-control" id="newVehiclePower" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleKm" class="form-label">Km Bilgisi *</label>
            <input type="number" class="form-control" id="newVehicleKm" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleTireDepth" class="form-label">Diş Derinlik Ölçümü *</label>
            <input type="text" class="form-control" id="newVehicleTireDepth" required>
          </div>
          <div class="col-md-6">
            <label for="newVehicleBatteryStatus" class="form-label">Akü Durumu</label>
            <input type="text" class="form-control" id="newVehicleBatteryStatus">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-primary" onclick="saveNewVehicle()">Kaydet</button>
      </div>
    </div>
  </div>
</div>

  <!-- JavaScript İşlemleri -->
  <script>
document.addEventListener("DOMContentLoaded", async function () {
  debugger;
  const flowId = getQueryParam("flowId");
  flatpickr("#siparisTarihi", {
    enableTime: true,
    dateFormat: "Y-m-d",
    defaultDate: new Date(),
    locale: flatpickr.l10ns.tr // Türkçe dil desteği
  });

  // Teslim Tarihi için datetime picker
  flatpickr("#teslimTarihi", {
    enableTime: true,
    dateFormat: "Y-m-d",
    defaultDate: new Date(),
    locale: flatpickr.l10ns.tr // Türkçe dil desteği
  });
debugger;
  if (flowId) {
    try {
      debugger;
      // Sales API'ye istek gönder
      const response = await fetch(`http://localhost:5186/api/v1/sales/${flowId}`);
      if (response.ok) {
        const result = await response.json();
        if (result.data.id>0) {
          // Kayıt mevcut, MasterId'yi bir alana yaz
       
          document.getElementById("masId").value = result.data.id;
            const kaydetButton = document.querySelector("button[onclick='kaydetMas()']");
              if (kaydetButton) 
              {
                kaydetButton.textContent = "Güncelle";
              }

          // Kayıt bilgilerini forma doldur
          populateFormWithSalesData(result.data);

          // Ürün ve müşteri dropdownlarını doldur
         fetchProducts();
         fetchCustomers();
         fetchVehicles();
         fetchSiparisTra();

          // Görsel düzenlemeler
          document.getElementById("productSelectionCard").style.display = "block";
          document.getElementById("siparisiOlusturButton").classList.remove("d-none");
        } else {
          fetchProducts();
          fetchCustomers();
          fetchVehicles();
          
        }
      } else {
        throw new Error("Sales API isteği başarısız oldu.");
      }
    } catch (error) {
      console.error("❌ Kayıt kontrolü sırasında hata oluştu:", error);
      // Yeni kayıt işlemleri
      await handleNewRecord();
    }
  } else {
    // Yeni kayıt işlemleri
    await handleNewRecord();
  }
});

// Yeni kayıt işlemleri
async function handleNewRecord() {
  try {
    await fetchProducts();
    await fetchCustomers();

    // Görsel düzenlemeler
    document.getElementById("productSelectionCard").style.display = "none";
    document.getElementById("siparisiOlusturButton").classList.add("d-none");

    console.log("✅ Yeni kayıt durumu: Popup'lar dolduruldu.");
  } catch (error) {
    console.error("❌ Yeni kayıt işlemleri sırasında hata oluştu:", error);
  }
}

// Sales API'den dönen verileri forma doldur
function populateFormWithSalesData(data) {
  debugger;
  const customerInput = document.getElementById("customerSelection");

  // API'den gelen customerCode'u dataset.code olarak set et
  customerInput.dataset.code = data.customerCode;

  debugger;
  // Rehberden (customers dizisinden) customerName'i bul
  const matchedCustomer = customers.find(customer => customer.customercode === data.customerCode);

  // Eğer eşleşen müşteri varsa, adı kullan; yoksa sadece kodu göster
  const customerName = matchedCustomer ? matchedCustomer.customername : "Bilinmeyen Müşteri";

  // Görünen değeri "customerCode - customerName" formatında ayarla
  customerInput.value = `${data.customerCode} - ${customerName}`;

  // Diğer alanları doldur
  document.getElementById("vehicleSelection").value = data.licensePlate || "";
  document.getElementById("plasiyerInput").value = data.salesrepno || "";
  document.getElementById("siparisTarihi").value = formatDateForInput(data.orderDate);
  document.getElementById("teslimTarihi").value = formatDateForInput(data.deliveryDate);
  document.getElementById("aciklama1").value = data.description || "";
  document.getElementById("aciklama2").value = data.description2 || "";
  document.getElementById("orderCodeHeader").placeholder = data.orderNumber || "";
}

// Tarih formatlama fonksiyonu
function formatDateForInput(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  return date.toISOString().split("T")[0]; // "yyyy-MM-dd"
}

// URL'den query parametrelerini al
function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

    // Global değişkenler
    let customers = [];
    let products = [];
    let kalemListesi = [];
    let vehicles = [];

    const plasiyerData = [
      { id: 1, name: "Ahmet Yılmaz" },
      { id: 2, name: "Mehmet Kaya" },
      { id: 3, name: "Ayşe Demir" },
      { id: 4, name: "Fatma Çelik" }
    ];

   async function fetchCustomers() {
  try {
    const response = await fetch('http://localhost:5186/api/v1/lookup/customers'); // Customers API'si
    if (!response.ok) {
      throw new Error('Müşteri verileri alınamadı.');
    }
    const data = await response.json();

    // Gelen veriyi kontrol edin
    console.log(data);

    // Eğer data bir dizi değilse, uygun diziyi seçin
    const customersArray = Array.isArray(data) ? data : data.data || [];

    // Gelen veriyi uygun formata dönüştür
    customers = customersArray.map(customer => ({

      createuser: customer.createuser || "Bilinmiyor",
      updateuser: customer.updateuser || "Bilinmiyor",
      wfstate: customer.wfstate || 0,
      customercode: customer.customercode || "Bilinmeyen Kod",
      customername: customer.customername || "Bilinmeyen İsim",
      vkntc: customer.vkntc || "Bilinmiyor",
      taxoffice: customer.taxoffice || "Bilinmiyor",
      address: customer.address || "Bilinmeyen Adres",
      telephone: customer.telephone || "Bilinmiyor Telefon",
      paymenttype: customer.paymenttype || 0,
      email: customer.email || "Bilinmeyen E-posta",
      flowid: customer.flowid || 0
    }));
    debugger;

    // Dropdown'ı doldur
    populateCustomerDropdown();
  } catch (error) {
    console.error('Müşteri verileri alınırken hata oluştu:', error);
  }
}

   async function fetchProducts() {
  try {
    const response = await fetch('http://localhost:5186/api/v1/lookup/stocks'); // Stocks API'si
    if (!response.ok) {
      throw new Error('Ürün verileri alınamadı.');
    }
    const data = await response.json();

    // Eğer data bir dizi değilse, uygun diziyi seçin
    const productsArray = Array.isArray(data) ? data : data.data || [];

    // Gelen veriyi uygun formata dönüştür
    products = productsArray.map(stock => ({
      stockCode: stock.code || "Bilinmeyen Kod",
      stockName: stock.name || "Bilinmeyen Ad",
      branchCode: stock.branchCode || "Bilinmiyor Şube"
    }));

    populateProductDropdown();
  } catch (error) {
    console.error('Ürün verileri alınırken hata oluştu:', error);
  }
}

async function fetchOrderCode() {
      try {
        const response = await fetch('siparisbilgi.json');
        if (!response.ok) {
          throw new Error('Failed to fetch order code');
        }
        const data = await response.json();
        const orderCodeInput = document.getElementById('orderCodeHeader');
        const plasiyerInput = document.getElementById('plasiyerInput');
        
        if (data.SiparisNo) {
          orderCodeInput.placeholder = data.SiparisNo;
        }
        if (data.PlasiyerName) {
          plasiyerInput.value = data.PlasiyerName;
        }
      } catch (error) {
        console.error('Error fetching order code or plasiyer name:', error);
      }
    }
	
	async function fetchSiparisMas(id) {
  try {
    const response = await fetch(`http://localhost:5186/api/v1/sales/${id}`); // Sales API'si
    if (!response.ok) throw new Error("Sipariş üst bilgileri alınamadı.");

    const masData = await response.json();

    if (!masData) {
      console.error("Sipariş üst bilgileri bulunamadı.");
      return;
    }

    const customerInput = document.getElementById("customerSelection");
    const customer = customers.find(c => c.code === masData.customercode);

    if (customer) {
      customerInput.value = `${customer.code} - ${customer.name}`;
      customerInput.dataset.code = customer.code;
      customerInput.dataset.name = customer.name;
    } else {
      customerInput.value = masData.customercode || "";
      customerInput.dataset.code = masData.customercode || "";
    }

    document.getElementById("plasiyerInput").value = masData.salesrepno || "";
    document.getElementById("siparisTarihi").value = masData.orderdate ? formatDateForInput(masData.orderdate) : "";
    document.getElementById("teslimTarihi").value = masData.deliverydate ? formatDateForInput(masData.deliverydate) : "";
    document.getElementById("aciklama1").value = masData.description || "";
    document.getElementById("aciklama2").value = masData.description2 || "";
    document.getElementById("masId").value = masData.id || "";

    document.getElementById("orderCodeHeader").placeholder = masData.ordernumber || "";

    console.log("✅ Sipariş üst bilgileri forma aktarıldı:", masData);
  } catch (error) {
    console.error("❌ Sipariş üst bilgileri yüklenemedi:", error);
  }
}

async function fetchSiparisTra() {
  try {
    // URL'den flowId değerini al
    const flowId = getQueryParam("flowId");
    if (!flowId) throw new Error("Flow ID bulunamadı.");

    // Sales Line API'sine istek gönder
    const response = await fetch(`http://localhost:5186/api/v1/sales/line/listlines/${flowId}`);
    if (!response.ok) throw new Error("SiparişTra API'sinden veri alınamadı.");

    const result = await response.json();

    // Döviz türlerini key değerlerinden metin değerlerine dönüştürmek için ters eşleme
    const currencyMap = {
      1: "TRY",
      2: "EUR",
      3: "USD"
    };

    // Kalem listesini güncelle
    kalemListesi = []; // Önce listeyi temizle
    for (let i = 0; i < result.data.length; i++) {
      debugger;
      const item = result.data[i];
      const product = products.find(p => p.stockCode === item.stockCode); // Ürün eşleşmesini kontrol et

      kalemListesi.push({
        id: item.id, // Veritabanındaki benzersiz kimlik
        stockcode: item.stockCode,
        stockname: product ? product.stockName : "Bilinmeyen Ürün", // Eşleşme varsa ürün adı, yoksa "Bilinmeyen Ürün"
        quantity: item.quantity,
        price: item.price,
        currency: currencyMap[item.currency] || "Bilinmiyor Döviz",
        discount: item.discount || 0 ,// İskonto oranı // Döviz türünü metin olarak dönüştür
        description: item.description || "",
        
      });
    }
    debugger;

    // Tabloyu güncelle
    populateProductTable();
    console.log("✅ SiparişTra verileri başarıyla yüklendi:", data);
  } catch (error) {
    console.error("❌ SiparişTra verisi yüklenemedi:", error);
  }
}

function populateProductTable() {
  const tableBody = document.getElementById("productTable").querySelector("tbody");
  tableBody.innerHTML = ""; // Mevcut tabloyu temizle

  kalemListesi.forEach((kalem, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${kalem.stockcode}</td>
      <td>${kalem.stockname}</td>
      <td>${kalem.price}</td>
      <td>${kalem.currency}</td>
      <td>
        <input type="number" class="form-control form-control-sm text-center" value="${kalem.quantity}" min="1" style="width: 80px;" onchange="updateQuantity(this, ${index})">
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-center" value="${kalem.discount}" min="0" max="100" step="0.01" style="width: 80px;" onchange="updateDiscount(this, ${index})">
      </td>
      <td>${kalem.description}</td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="removeProduct(${index}, this)">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;

    // Çift tıklama olayını bağla
    row.ondblclick = () => editProduct(index);

    tableBody.appendChild(row);
  });

  // Tabloyu görünür yap
  document.getElementById("productTable").style.display = kalemListesi.length > 0 ? "table" : "none";
}

// Yardımcı tarih formatlayıcı
function formatDateForInput(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  return date.toISOString().split("T")[0]; // "yyyy-MM-dd"
}

	function populateCustomerDropdown() {
  const dropdown = document.getElementById("customerDropdown");
  dropdown.innerHTML = ""; // Mevcut dropdown öğelerini temizle
debugger;
  customers.forEach(customer => {
    const item = document.createElement("li");
    item.classList.add("dropdown-item");
    item.innerHTML = `<strong>${customer.customercode}</strong> - ${customer.customername}`; // Cari kodu ve ismi göster
    item.dataset.code = customer.customercode; // CUSTOMERCODE'u data-code olarak sakla
    item.dataset.name = customer.customername; // CUSTOMERNAME'i data-name olarak sakla
    item.onclick = () => selectCustomer(customer); // Seçim yapıldığında selectCustomer çağrılır
    dropdown.appendChild(item);
  });
}



   function populateProductDropdown() {
  const dropdown = document.getElementById("productDropdown");
  dropdown.innerHTML = ""; // Mevcut dropdown öğelerini temizle

  products.forEach(product => {
    const item = document.createElement("li");
    item.classList.add("dropdown-item");
    item.style.cursor = "pointer"; // Tıklanabilir hale getir
    item.textContent = `${product.stockCode} - ${product.stockName}`; // STOK KODU ve STOK ADI birleştirildi
    item.dataset.code = product.stockCode; // STOK_KODU'nu data-code olarak sakla
    item.dataset.name = product.stockName; // STOK_ADI'nı data-name olarak sakla
    item.onclick = () => selectProduct(product); // Seçim yapıldığında selectProduct çağrılır
    dropdown.appendChild(item);
  });
}

function filterCustomers() {
  const input = document.getElementById("customerSelection").value.toLowerCase();
  const dropdown = document.getElementById("customerDropdown");
  dropdown.innerHTML = ""; // Mevcut dropdown öğelerini temizle

  // Müşterileri filtrele (küçük "n" kullanıyoruz)
  const filteredCustomers = input
    ? customers.filter(customer =>
        customer.customername.toLowerCase().includes(input) || 
        customer.customercode.toLowerCase().includes(input)
      )
    : customers;

  // Filtrelenmiş müşterileri dropdown'a ekle
  filteredCustomers.forEach(customer => {
    const item = document.createElement("li");
    item.classList.add("dropdown-item");
    item.style.cursor = "pointer";
    item.textContent = `${customer.customercode} - ${customer.customername}`; // Tutarlı kullanım
    item.dataset.code = customer.customercode;
    item.dataset.name = customer.customername;
    item.onclick = () => selectCustomer(customer);
    dropdown.appendChild(item);
  });

  dropdown.style.display = filteredCustomers.length > 0 ? "block" : "none";
}

    function selectCustomer(customer) {
  const customerInput = document.getElementById("customerSelection");
  customerInput.value = `${customer.customercode} - ${customer.customername}`; // Müşteri kodu ve adı birleştirilir
  customerInput.dataset.code = customer.customercode; // CUSTOMERCODE'u sakla
  customerInput.dataset.name = customer.customername; // CUSTOMERNAME'i sakla
  document.getElementById("customerDropdown").style.display = "none"; // Dropdown'u gizle
}

    function setCustomerType(customer) {
     /*       document.getElementById("tipi").value = customer.type || "";
      document.getElementById("dovizTipi").value = customer.currency || "";
      */
    }

    function expandCustomerField() {
      document.getElementById("customerSelection").style.width = "100%";
      document.getElementById("customerDropdown").style.display = "block";
    }

    function populateProductDropdown() {
  const dropdown = document.getElementById("productDropdown");
  dropdown.innerHTML = ""; // Mevcut dropdown öğelerini temizle

  products.forEach(product => {
    const item = document.createElement("li");
    item.classList.add("dropdown-item");
    item.style.cursor = "pointer"; // Tıklanabilir hale getir
    item.textContent = `${product.stockCode} - ${product.stockName}`; // Stok kodu ve stok adı birleştirildi
    item.dataset.code = product.stockCode; // Stok kodunu data-code olarak sakla
    item.dataset.name = product.stockName; // Stok adını data-name olarak sakla
    item.onclick = () => selectProduct(product); // Seçim yapıldığında selectProduct çağrılır
    dropdown.appendChild(item);
  });
}

function filterProducts() {
  const input = document.getElementById("productSelection").value.toLowerCase();
  const dropdown = document.getElementById("productDropdown");
  dropdown.innerHTML = ""; // Mevcut dropdown öğelerini temizle

  // Ürünleri filtrele
  const filteredProducts = input
    ? products.filter(product =>
        product.stockName.toLowerCase().includes(input) ||
        product.stockCode.toLowerCase().includes(input)
      )
    : products;

  // Filtrelenmiş ürünleri dropdown'a ekle
  filteredProducts.forEach(product => {
    const item = document.createElement("li");
    item.classList.add("dropdown-item");
    item.style.cursor = "pointer"; // Tıklanabilir hale getir
    item.textContent = `${product.stockCode} - ${product.stockName}`; // Stok kodu ve stok adı birleştirildi
    item.dataset.code = product.stockCode; // Stok kodunu data-code olarak sakla
    item.dataset.name = product.stockName; // Stok adını data-name olarak sakla
    item.onclick = () => selectProduct(product); // Seçim yapıldığında selectProduct çağrılır
    dropdown.appendChild(item);
  });

  // Dropdown'u göster veya gizle
  dropdown.style.display = filteredProducts.length > 0 ? "block" : "none";
}

function showAllProducts() {
  const dropdown = document.getElementById("productDropdown");
  dropdown.innerHTML = ""; // Mevcut dropdown öğelerini temizle

  products.forEach(product => {
    const item = document.createElement("li");
    item.classList.add("dropdown-item");
    item.style.cursor = "pointer"; // Tıklanabilir hale getir
    item.textContent = `${product.stockCode} - ${product.stockName}`; // Stok kodu ve stok adı birleştirildi
    item.dataset.code = product.stockCode; // Stok kodunu data-code olarak sakla
    item.dataset.name = product.stockName; // Stok adını data-name olarak sakla
    item.onclick = () => selectProduct(product); // Seçim yapıldığında selectProduct çağrılır
    dropdown.appendChild(item);
  });

  dropdown.style.display = "block";
}

function selectProduct(product) {
  const input = document.getElementById("productSelection");
  input.value = `${product.stockCode} - ${product.stockName}`; // Seçilen ürünün birleştirilmiş formatı
  input.dataset.code = product.stockCode; // Stok kodunu sakla
  input.dataset.name = product.stockName; // Stok adını sakla

  // Dropdown'u gizle
  document.getElementById("productDropdown").style.display = "none";
}

async function addProduct() {
  const customerInput = document.getElementById("customerSelection").value.trim();
  if (!customerInput) {
    showError("Lütfen önce bir müşteri seçiniz!");
    return;
  }

  const productInput = document.getElementById("productSelection");
  const quantityInput = document.getElementById("productQuantity");
  const priceInput = document.getElementById("productPrice");
  const currencyInput = document.getElementById("currencyType");
  const descriptionInput = document.getElementById("description");
  const discountInput = document.getElementById("productDiscount");
  const userId=getQueryParam("userId");

  const productValue = productInput.value.trim();
  const quantityValue = parseFloat(quantityInput.value.trim());
  const priceValue = parseFloat(priceInput.value.trim());
  const currencyValue = currencyInput.value;
  const descriptionValue = descriptionInput.value.trim();
  const discountValue = parseFloat(discountInput.value.trim()) || 0;

  if (!productValue || quantityValue <= 0 || priceValue <= 0) {
    showError("Lütfen geçerli bir ürün, miktar ve fiyat giriniz!");
    return;
  }

  const code = productInput.dataset.code;
  const name = productInput.dataset.name;

  if (!code || !name) {
    showError("Geçerli bir ürün seçiniz!");
    return;
  }

  const masterId = document.getElementById("masId").value;
  if (!masterId) {
    showError("Sipariş üst bilgisi kaydedilmedi. Lütfen önce üst bilgiyi kaydedin.");
    return;
  }

  const lineData = {
    id: 0, // Yeni ürün için ID 0 gönderiliyor
    userId: userId || "defaultUser", // Kullanıcı ID'si
    createDate: new Date().toISOString(),
    updateDate: new Date().toISOString(),
    wfState: 0, // Varsayılan workflow durumu
    masterId: parseInt(masterId), // Sipariş üst bilgisi ID'si
    flowId:   (parseInt(getQueryParam("flowId")) || 0), // Flow ID
    stockCode: code, // Ürün kodu
    amount: quantityValue, // Miktar
    price: priceValue, // Fiyat
    discountRate: discountValue, // İskonto oranı
    currencyId: getCurrencyKey(currencyValue), // Döviz türü
    description: descriptionValue // Açıklama
  };

  try {
    const response = await fetch('/api/v1/sales/line', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(lineData),
    });

    if (!response.ok) throw new Error('Satır eklenemedi.');

    const result = await response.json();
    console.log("✅ Satır başarıyla eklendi:", result);

    // Kalem listesini güncelle
    kalemListesi.push({
      ...lineData,
      id: result.id, // Backend'den dönen ID
    });

    // Tabloyu güncelle
    populateProductTable();

    // Input alanlarını temizle
    resetProductForm();

    // Proforma butonunu kontrol et
    toggleProformaButton();
  } catch (error) {
    console.error("❌ Satır eklenemedi:", error);
    showError("Satır eklenemedi. Lütfen tekrar deneyiniz.");
  }
}
   

  

   function showError(message) {
  const errorAlert = document.getElementById("errorAlert");
  errorAlert.textContent = message;
  errorAlert.style.zIndex = "1060"; // Modalın üzerinde görünmesi için z-index ayarı
  errorAlert.classList.remove("d-none");
  setTimeout(() => {
    errorAlert.classList.add("d-none");
  }, 3000);
}

    function toggleProformaButton() {
      const tableBody = document.getElementById("productTable").querySelector("tbody");
      const proformaButton = document.getElementById("proformaButton");
      proformaButton.classList.toggle("d-none", tableBody.rows.length === 0);
    }

    function replaceTurkishCharacters(text) {
      const turkishMap = {
        "ç": "c",
        "ğ": "g",
        "ı": "i",
        "ö": "o",
        "ş": "s",
        "ü": "u",
        "Ç": "C",
        "Ğ": "G",
        "İ": "I",
        "Ö": "O",
        "Ş": "S",
        "Ü": "U"
      };
      return text.replace(/[çğıöşüÇĞİÖŞÜ]/g, char => turkishMap[char] || char);
    }

    async function generateProforma() {
  const orderNumber = replaceTurkishCharacters(document.getElementById("orderCodeHeader").placeholder || "N/A");
  const customerName = replaceTurkishCharacters(document.getElementById("customerSelection").value || "N/A");
  const orderDate = replaceTurkishCharacters(document.getElementById("siparisTarihi").value || "N/A");
  const deliveryDate = replaceTurkishCharacters(document.getElementById("teslimTarihi").value || "N/A");

  const doc = new jspdf.jsPDF();

  // Başlık
  doc.setFillColor(161, 196, 253);
  doc.rect(0, 0, 210, 30, "F");
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.setTextColor(255, 255, 255);
  doc.text(replaceTurkishCharacters("Proforma Faturası"), 105, 15, { align: "center" });

  // Sipariş detayları
  doc.setFontSize(12);
  doc.setFont("helvetica", "normal");
  doc.setTextColor(0, 0, 0);
  doc.text(`Sipariş No: ${orderNumber}`, 15, 45);
  doc.text(`Müşteri Adı: ${customerName}`, 15, 52);
  doc.text(`Sipariş Tarihi: ${orderDate}`, 15, 59);
  doc.text(`Teslim Tarihi: ${deliveryDate}`, 15, 66);

  // Ürün tablosu
  const tableBody = [];
  const rows = document.querySelectorAll("#productTable tbody tr");

  rows.forEach((row, index) => {
    const cells = row.querySelectorAll("td");
    const price = cells[3].textContent.trim();
    const currency = cells[4].textContent.trim();
    const quantity = cells[5].querySelector("input").value.trim();
    const description = cells[6].querySelector("input").value.trim();

    tableBody.push([
      index + 1, // Sıra numarası
      replaceTurkishCharacters(cells[1].textContent.trim()), // Ürün Kodu
      replaceTurkishCharacters(cells[2].textContent.trim()), // Ürün Adı
      `${price} ${currency}`, // Fiyat ve Döviz
      quantity, // Miktar
      replaceTurkishCharacters(description) // Açıklama
    ]);
  });

  doc.autoTable({
    head: [["#", "Ürün Kodu", "Ürün Adı", "Fiyat (Döviz)", "Miktar", "Açıklama"]],
    body: tableBody,
    startY: 75,
    theme: "grid",
    styles: {
      font: "helvetica",
      fontSize: 10,
      cellPadding: 3,
      halign: "center",
      valign: "middle",
    },
    headStyles: {
      fillColor: [0, 123, 255],
      textColor: [255, 255, 255],
      fontStyle: "bold",
    },
    alternateRowStyles: {
      fillColor: [240, 240, 240],
    },
  });

  // Alt bilgi
  const pageHeight = doc.internal.pageSize.height;
  doc.setFillColor(161, 196, 253);
  doc.rect(0, pageHeight - 20, 210, 20, "F");
  doc.setFontSize(10);
  doc.setTextColor(255, 255, 255);
  doc.text(replaceTurkishCharacters("Copyright © 2024. Created by Uzser Bilişim Hizmetleri"), 105, pageHeight - 10, { align: "center" });

  // PDF'yi indir
  doc.save(`Proforma_${orderNumber}.pdf`);
}

    function toggleOrderInfo() {
      const orderInfoBody = document.getElementById("orderInfoBody");
      const toggleIcon = document.getElementById("toggleOrderInfoIcon");
      if (orderInfoBody.style.display === "none" || orderInfoBody.style.display === "") {
        orderInfoBody.style.display = "block";
        toggleIcon.classList.remove("bi-plus-lg");
        toggleIcon.classList.add("bi-dash-lg");
      } else {
        orderInfoBody.style.display = "none";
        toggleIcon.classList.remove("bi-dash-lg");
        toggleIcon.classList.add("bi-plus-lg");
      }
    }

    function handleEnter(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        addProduct();
      }
    }



    function openNewCustomerModal() {
      const modal = new bootstrap.Modal(document.getElementById('newCustomerModal'));
      modal.show();
    }

   function getGroupedData() {
  const groups = {};
  const fields = document.querySelectorAll("input[class*='data-'], select[class*='data-'], textarea[class*='data-']");

  fields.forEach(field => {
    const groupClass = Array.from(field.classList).find(c => c.startsWith("data-"));
    if (!groupClass) return;

    const groupKey = groupClass.replace("data-", "");
    if (!groups[groupKey]) groups[groupKey] = {};

    const name = field.name;
    if (!name) {
      console.warn(`⚠️ input ${field.id || '[no id]'} has no name attribute.`);
      return;
    }

    let value = field.value;
    if (field.type === "number") {
      value = parseFloat(value) || 0;
    }

    groups[groupKey][name] = value;
  });

  console.log("🔍 getGroupedData result:", groups);
  return groups;
}
async function kaydetMas() {
  debugger;
  const groups = getGroupedData();
  // MasId alanını al, boş ise 0 olarak kullan
  const idValue = document.getElementById("masId")?.value;
  const masId = idValue ? parseInt(idValue) : 0; // id boşsa 0 gönder

  const discountRate = parseFloat(document.getElementById("iskontoOrani").value) || 0;

  // URL'den userId ve flowId değerlerini al
  const userId = getQueryParam("userId") || "unknownUser";
  const flowId = getQueryParam("flowId") || 0;

  const customerCode = document.getElementById("customerSelection").dataset.code || "";
  const licensePlate = document.getElementById("vehicleSelection").dataset.plate || "";
 debugger;
  const masData = {
    id: masId, // Eğer id boş ise 0 gönderilir
    userId: userId,
    wfState: 0,
    flowId: parseInt(flowId),
    customerCode: customerCode,
    licensePlate: licensePlate,
    orderDate: document.getElementById("siparisTarihi").value || null,
    deliveryDate: document.getElementById("teslimTarihi").value || null,
    description: document.getElementById("aciklama1").value || "",
    description2: document.getElementById("aciklama2").value || "",
    discountRate: discountRate,
  };

  try {
    debugger;
    const response = await fetch('http://localhost:5186/api/v1/sales', {
      method: 'POST', // Hem ekleme hem güncelleme için aynı metot kullanılıyor
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(masData),
    });

    if (!response.ok) throw new Error('Üst bilgi kaydedilemedi.');

    const result = await response.json();
  
    console.log("✅ Üst bilgi başarıyla kaydedildi:", result);

    // Sipariş detaylarını yenile
    fetchSiparisTra(result.id);

    // "Siparişi Oluştur" butonunu görünür yap
    const siparisiOlusturButton = document.getElementById("siparisiOlusturButton");
    siparisiOlusturButton.classList.remove("d-none");

    document.getElementById("productSelectionCard").style.display = "block";

    // "Kaydet" butonunu "Güncelle" olarak güncelle
    const kaydetButton = document.querySelector("button[onclick='kaydetMas()']");
    if (kaydetButton) {
      kaydetButton.textContent = "Güncelle";
    }
  } catch (error) {
    console.error("❌ Üst bilgi kaydedilemedi:", error);
    showError("Üst bilgi kaydedilemedi. Lütfen tekrar deneyiniz.");
  }
}




   

    function tumVerileriKaydet() {
      const groups = getGroupedData();
      if (groups.mas) kaydetMas(groups.mas);
      kaydetTra();
      // İleride: if (groups.cari) { ... }, if (groups.tra2) { ... }
    }
	
	function refreshOrderInfo() {
	debugger;
	/*
	setTimeout(() => {
    fetchSiparisMas(kayitId);
  }, 2000);
  */
 
 window.link_was_clicked = true;
 setTimeout(function() {
    location.reload();
	window.parent.location.reload();
}, 10);
  
}
	
	let editingIndex = null; // Güncellenen kalemin indeksini tutar
	
   async function saveNewCustomer() {
  const customerName = document.getElementById("newCustomerName").value.trim();
  const customerCode = document.getElementById("newCustomerCode").value.trim();
  const vknTc = document.getElementById("vknTc").value.trim();
  const taxOffice = document.getElementById("vergiDairesi").value.trim();
  const address = document.getElementById("adres").value.trim();
  const telephone = document.getElementById("telefon").value.trim();
  const paymentTypeStr = document.getElementById("odemeTipi").value;
  const email = document.getElementById("eposta").value.trim();
  const userId=getQueryParam("userId") || "unknownUser"; // URL'den userId alınır

  // Zorunlu alan kontrolü
  if (!customerName || !customerCode || !vknTc) {
    showError("Lütfen zorunlu alanları doldurunuz!");
    return;
  }

  // Ödeme tipini dönüştür (paymentTypeKeys global obje tanımlı olmalı)
  const paymentTypeKey = paymentTypeKeys[paymentTypeStr] !== undefined ? paymentTypeKeys[paymentTypeStr] : 0;

  // URL'den flowId alınır (ilgili query parametresi yoksa 0 alınır)
  const flowId = parseInt(getQueryParam("flowId")) || 0;

  const customerData = {
    id: 0,
    createDate: new Date().toISOString(),
    createUser: userId,
    updateDate: new Date().toISOString(),
    updateUser: userId,
    wfState: 0,
    customerCode: customerCode,
    customerName: customerName,
    vknTc: vknTc,
    taxOffice: taxOffice,
    address: address,
    telephone: telephone,
    paymentType: paymentTypeKey,
    email: email,
    flowId: flowId
  };

  try {
    const response = await fetch('http://localhost:5186/api/v1/customers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(customerData)
    });

    const result = await response.json();

    if (!result.success) {
      if (result.errorCode === "BUSINESS") {
        showError(result.errorDetail || "İş mantığı hatası oluştu.");
      } else {
        throw new Error('Cari eklenemedi.');
      }
      return;
    }

    console.log("✅ Cari başarıyla eklendi:", result);

    // Cari lookup listesini yenilemek için fetchCustomers() çağrılıyor
    await fetchCustomers();

    // Müşteri seçim alanını güncelle
    const input = document.getElementById("customerSelection");
    input.value = `${customerData.customercode} - ${customerData.customername}`;
    input.dataset.code = customerData.customercode;
    input.dataset.name = customerData.customername;

    // Modal'ı kapat
    const modal = bootstrap.Modal.getInstance(document.getElementById('newCustomerModal'));
    modal.hide();
  } catch (error) {
    console.error("❌ Cari eklenemedi:", error);
    showError("Cari eklenemedi. Lütfen tekrar deneyiniz.");
  }
}
    function editProduct(index) {
  const kalem = kalemListesi[index];

  if (!kalem) {
    showError("Seçilen ürün bulunamadı!");
    return;
  }

  // Bilgileri yukarıdaki alanlara yükle
  document.getElementById("productSelection").value = kalem.stockname || "";
  document.getElementById("productSelection").dataset.code = kalem.stockcode || "";
  document.getElementById("productQuantity").value = kalem.quantity || "";
  document.getElementById("productPrice").value = kalem.price || "";
  document.getElementById("currencyType").value = kalem.currency || "TRY";
  document.getElementById("description").value = kalem.description || ""; // Açıklama alanını doldur
  document.getElementById("productDiscount").value = kalem.discount || 0; // İskonto alanını doldur

  // "Ekle" butonunu "Güncelle" butonuna dönüştür
  const addButton = document.querySelector("button[onclick='addProduct()']");
  addButton.textContent = "Güncelle";
  addButton.setAttribute("onclick", `updateProduct(${index})`);
  


  // Güncellenen kalemin indeksini kaydet
  editingIndex = index;
}

function updateProduct(index) {
  const productInput = document.getElementById("productSelection");
  const quantityInput = document.getElementById("productQuantity");
  const priceInput = document.getElementById("productPrice");
  const currencyInput = document.getElementById("currencyType");
  const descriptionInput = document.getElementById("description");
  const discountInput = document.getElementById("productDiscount");

  const productValue = productInput.value.trim();
  const quantityValue = parseFloat(quantityInput.value.trim());
  const priceValue = parseFloat(priceInput.value.trim());
  const currencyValue = currencyInput.value;
  const descriptionValue = descriptionInput.value.trim(); // Açıklama alanının değeri
  const discountValue = parseFloat(discountInput.value.trim()) || 0; // İskonto değerini al

  if (!productValue || quantityValue <= 0 || priceValue <= 0) {
    showError("Lütfen geçerli bir ürün, miktar ve fiyat giriniz!");
    return;
  }

  const code = productInput.dataset.code;
  const name = productInput.dataset.name;

  if (!code || !name) {
    showError("Geçerli bir ürün seçiniz!");
    return;
  }

  // Kalem listesini güncelle
  kalemListesi[index] = {
    ...kalemListesi[index], // Mevcut id değerini koru
    stockcode: code,
    stockname: name,
    quantity: quantityValue,
    price: priceValue,
    currency: currencyValue,
    description: descriptionValue, // Açıklama alanını güncelle
    discount: discountValue // İskonto alanını güncelle
  };

  // Tabloyu güncelle
  const tableBody = document.getElementById("productTable").querySelector("tbody");
  const row = tableBody.rows[index];
  row.cells[1].textContent = code;
  row.cells[2].textContent = name;
  row.cells[3].textContent = priceValue.toFixed(2); // Fiyatı formatla
  row.cells[4].textContent = currencyValue;
  row.cells[5].textContent = quantityValue;
  row.cells[6].textContent = discountValue; // İskonto alanını güncelle
  row.cells[7].textContent = descriptionValue; // Açıklama alanını güncelle

  // Alanları temizle ve "Güncelle" butonunu "Ekle" butonuna dönüştür
  resetProductForm();
}

function resetProductForm() {
  document.getElementById("productSelection").value = "";
  document.getElementById("productSelection").dataset.code = "";
  document.getElementById("productQuantity").value = "";
  document.getElementById("productPrice").value = "";
  document.getElementById("currencyType").value = "TRY";
  document.getElementById("description").value = ""; // Açıklama alanını temizle
  document.getElementById("productDiscount").value = 0; // İskonto alanını sıfırla

  // "Güncelle" butonunu "Ekle" butonuna dönüştür
  const addButton = document.querySelector("button[onclick^='updateProduct']");
  if (addButton) {
    addButton.textContent = "Ekle";
    addButton.setAttribute("onclick", "addProduct()");
  }

  editingIndex = null; // Güncelleme durumu sıfırla
}


async function fetchVehicles() {
  try {
    const response = await fetch('http://localhost:5186/api/v1/lookup/vehicles'); // Vehicles API'si
    if (!response.ok) {
      throw new Error('Araç verileri alınamadı.');
    }
    const data = await response.json();

    // Eğer data bir dizi değilse, uygun diziyi seçin
    const vehiclesArray = Array.isArray(data) ? data : data.data || [];

    // Gelen veriyi uygun formata dönüştür
    vehicles = vehiclesArray.map(vehicle => ({
      id: vehicle.id || 0,
      createDate: vehicle.createDate || "Bilinmeyen Tarih",
      createUser: vehicle.createUser || "Bilinmeyen Kullanıcı",
      updateDate: vehicle.updateDate || null,
      updateUser: vehicle.updateUser || "Bilinmeyen Kullanıcı",
      wfState: vehicle.wfState || 0,
      vehiclePlate: vehicle.vehiclePlate || "Bilinmeyen Plaka",
      chassisNumber: vehicle.chassisNumber || "Bilinmeyen Şasi",
      engineNumber: vehicle.engineNumber || "Bilinmeyen Motor No",
      brand: vehicle.brand || "Bilinmeyen Marka",
      model: vehicle.model || "Bilinmeyen Model",
      modelYear: vehicle.modelYear || "Bilinmeyen Yıl",
      fuelType: vehicle.fuelType || "Bilinmeyen Yakıt Tipi",
      enginePower: vehicle.enginePower || "Bilinmeyen Motor Gücü",
      kilometer: vehicle.kilometer || "Bilinmeyen Km",
      tireTreadDepth: vehicle.tireTreadDepth || "Bilinmeyen Diş Derinliği",
      batteryStatus: vehicle.batteryStatus || "Bilinmeyen Akü Durumu",
    }));

    // Dropdown'u doldur
    populateVehicleDropdown();
  } catch (error) {
    console.error('Araç verileri alınırken hata oluştu:', error);
  }
}

function populateVehicleDropdown() {
  const dropdown = document.getElementById("vehicleDropdown");
  dropdown.innerHTML = "";
  vehicles.forEach(vehicle => {
    const item = document.createElement("li");
    item.classList.add("dropdown-item");
    item.textContent = `${vehicle.vehiclePlate} - ${vehicle.chassisNumber}`;
    item.onclick = () => selectVehicle(vehicle);
    dropdown.appendChild(item);
  });
}

function filterVehicles() {
  const input = document.getElementById("vehicleSelection").value.toLowerCase();
  const dropdown = document.getElementById("vehicleDropdown");
  dropdown.innerHTML = "";
  const filtered = input
    ? vehicles.filter(v =>
        v.plate.toLowerCase().includes(input) ||
        v.chassis.toLowerCase().includes(input)
      )
    : vehicles;
  filtered.forEach(vehicle => {
    const item = document.createElement("li");
    item.classList.add("dropdown-item");
    item.textContent = `${vehicle.plate} - ${vehicle.chassis}`;
    item.onclick = () => selectVehicle(vehicle);
    dropdown.appendChild(item);
  });
  dropdown.style.display = filtered.length > 0 ? "block" : "none";
}

function selectVehicle(vehicle) {
  const input = document.getElementById("vehicleSelection");
  input.value = `${vehicle.vehiclePlate} - ${vehicle.chassisNumber}`;
  input.dataset.plate = vehicle.vehiclePlate;
  input.dataset.chassis = vehicle.chassisNumber;
  document.getElementById("vehicleDropdown").style.display = "none";
}

function expandVehicleField() {
  document.getElementById("vehicleDropdown").style.display = "block";
}

function openNewVehicleModal() {
  document.getElementById('newVehiclePlate').value = "";
  document.getElementById('newVehicleChassis').value = "";
  const modal = new bootstrap.Modal(document.getElementById('newVehicleModal'));
  modal.show();
}

async function saveNewVehicle() {
  const vehicleData = {
    id: 0, // Yeni araç için ID 0 gönderiliyor
    createUser: "currentUser", // Kullanıcı bilgisi eklenmeli

    updateUser: "currentUser", // Kullanıcı bilgisi eklenmeli
    wfState: 0, // Varsayılan workflow durumu
    vehiclePlate: document.getElementById("newVehiclePlate").value.trim(),
    chassisNumber: document.getElementById("newVehicleChassis").value.trim(),
    engineNumber: document.getElementById("newVehicleEngine").value.trim(),
    brand: document.getElementById("newVehicleBrand").value.trim(),
    model: document.getElementById("newVehicleModel").value.trim(),
    modelYear: document.getElementById("newVehicleYear").value.trim(),
    fuelType: document.getElementById("newVehicleFuelType").value.trim(),
    enginePower: document.getElementById("newVehiclePower").value.trim(),
    kilometer: document.getElementById("newVehicleKm").value.trim(),
    tireTreadDepth: document.getElementById("newVehicleTireDepth").value.trim(),
    batteryStatus: document.getElementById("newVehicleBatteryStatus").value.trim(),
  };

  if (!vehicleData.vehiclePlate || !vehicleData.chassisNumber || !vehicleData.engineNumber || !vehicleData.brand || !vehicleData.model) {
    showError("Lütfen zorunlu alanları doldurunuz!");
    return;
  }

  try {
    const response = await fetch('http://localhost:5186/api/v1/vehicles', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(vehicleData),
    });

    const result = await response.json();
    if (!result.success) {
      if (result.errorCode === "BUSINESS") {
        showError(result.errorDetail || "İş mantığı hatası oluştu.");
      } else {
        throw new Error('Araç eklenemedi.');
      }
      return;
    }

    console.log("✅ Araç başarıyla eklendi:", result);

    // Lookup listesini yenilemek için fetchVehicles() çağırılıyor
    await fetchVehicles();

    // Input alanını güncelle
    const input = document.getElementById("vehicleSelection");
    input.value = `${vehicleData.vehiclePlate} - ${vehicleData.chassisNumber}`;
    input.dataset.plate = vehicleData.vehiclePlate;
    input.dataset.chassis = vehicleData.chassisNumber;

    // Modal'ı kapat
    const modal = bootstrap.Modal.getInstance(document.getElementById('newVehicleModal'));
    modal.hide();
  } catch (error) {
    console.error("❌ Araç eklenemedi:", error);
    showError("Araç eklenemedi. Lütfen tekrar deneyiniz.");
  }
}

async function removeProduct(index, button) {
  const kalem = kalemListesi[index];
  if (!kalem || !kalem.id) {
    showError("Silinecek ürün bulunamadı veya ID eksik!");
    return;
  }

  // URL'den userId'yi al
  const userId = getQueryParam("userId") || "unknownUser";

  // SweetAlert ile onay penceresi
  const result = await Swal.fire({
    title: 'Emin misiniz?',
    text: "Bu ürünü silmek istediğinize emin misiniz?",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Evet, sil!',
    cancelButtonText: 'Hayır'
  });

  if (!result.isConfirmed) return;

  try {
    // API'ye POST isteği gönder (delete-line metodu)
    const response = await fetch(`http://localhost:5186/api/v1/sales/line/delete-line`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: kalem.id, // Silinecek satırın ID'si
        userId: userId // Silen kullanıcı
      }),
    });

    if (!response.ok) throw new Error("Ürün silinemedi!");

    // Kalem listesinden ilgili ürünü kaldır
    kalemListesi.splice(index, 1);

    // Tabloyu güncelle
    populateProductTable();

    Swal.fire(
      'Silindi!',
      'Ürün başarıyla silindi.',
      'success'
    );

    console.log(`✅ Ürün başarıyla silindi. Kalan ürün sayısı: ${kalemListesi.length}`);
  } catch (error) {
    console.error("❌ Ürün silinemedi:", error);
    Swal.fire(
      'Hata!',
      'Ürün silinemedi. Lütfen tekrar deneyiniz.',
      'error'
    );
  }
}

// Döviz türlerini key değerleriyle eşleştiren bir nesne
const currencyKeys = {
  "USD": 3,
 
  "EUR": 2,
  "TRY": 1
};

const paymentTypeKeys = {
  "Nakit": 0,
  "Kredi Kartı": 1
};

// Döviz türüne göre key değerini döndüren bir fonksiyon
function getCurrencyKey(currency) {
  return currencyKeys[currency] || 0; // Eğer eşleşme yoksa varsayılan olarak 0 döner
}

function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

// Örnek kullanım
document.addEventListener("click", function (event) {
  const customerDropdown = document.getElementById("customerDropdown");
  const vehicleDropdown = document.getElementById("vehicleDropdown");

  // Eğer tıklanan öğe dropdown veya input değilse dropdown'u kapat
  if (!customerDropdown.contains(event.target) && event.target.id !== "customerSelection") {
    customerDropdown.style.display = "none";
  }

  if (!vehicleDropdown.contains(event.target) && event.target.id !== "vehicleSelection") {
    vehicleDropdown.style.display = "none";
  }
});
  </script>
</body>
</html>
